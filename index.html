<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1 id="status">averyblouin.github.io</h1>
    <br>
    <div id="buttons"></div>

    <script>
        const buttons = document.getElementById("buttons");
        const status = document.getElementById("status");

        const games = {
            "Eaglercraft": "/source.txt",
            "Hollow Knight": "/hollowcat",
            "Celeste": "/celeste-wasm/index.html",
        };

        function launch(source) {
            let win = window.open("about:blank");
            let iframe = win.document.createElement("iframe");

            win.document.write(source);
            win.document.close();

            window.location.replace("https://www.google.com");
        }

        let downloading = false;
        async function downloadGame(url) {
            if (downloading) {return [false, "Download still in progress."];}
            let e;

            downloading = true;
            try {
                status.innerText = "Fetching...";

                let esrc = await fetch(url);
                if (esrc.status != 200) {
                    status.innerText = `Failed to fetch game: status code ${esrc.status}`;
                } else {
                    esrc = await esrc.text();

                    status.innerText = "Game downloaded, click the launch button.";
                    return [true, esrc];
                }
            } catch(err) {
                status.innerText = `Failed to fetch game: ${err}`;
                e = err;
            }

            downloading = false;
            return [false, e];
        }

        async function handleClick() {
            const url = games[this.innerHTML];
            if (!url) {
                alert("Site is very broken idk");
                return;
            }

            const [success, res] = await downloadGame(url);
            if (!success) {return;}

            buttons.remove();

            const launchb = document.createElement("button");
            launchb.innerHTML = "Launch";
            launchb.onclick = function() {
                launch(res);
            }
            document.body.append(launchb);
        }

        for (const [k,v] of Object.entries(games)) {
            const b = document.createElement("button");
            b.innerHTML = k;
            b.onclick = handleClick;
            buttons.append(b);
        }
    </script>
</body>
</html>


